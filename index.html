<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet Map (KML + GeoJSON + Icons)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Leaflet CSS and JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Omnivore for KML -->
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <!-- Leaflet Awesome Markers CSS & JS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.min.js"></script>

  <!-- FontAwesome 4.7.0 for compatibility -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
  />

  <style>
    html,
    body,
    #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Loading indicator */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }

    /* Custom tooltip style for station names */
    .station-tooltip {
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      border-radius: 3px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    /* Legend */
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      line-height: 18px;
      font-size: 14px;
      color: #333;
      user-select: none;
    }

    .legend-item {
      margin: 4px 0;
      display: flex;
      align-items: center;
    }

    .legend-color {
      width: 20px;
      height: 4px;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
      border-radius: 2px;
    }

    .legend-icon {
      margin-right: 8px;
      font-size: 16px;
      line-height: 1;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">
    <i class="fa fa-spinner fa-spin"></i> Loading...
  </div>

  <script>
    // Initialize map
    const map = L.map("map").setView([16.5, 102.5], 8);

    // Show/hide loading indicator
    function showLoading() {
      document.getElementById("loading").style.display = "block";
    }
    function hideLoading() {
      document.getElementById("loading").style.display = "none";
    }

    // Add base map layer
    const baseMap = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }
    ).addTo(map);

    // Layer groups
    const layerALTrack = L.layerGroup();
    const layerStationLayout = L.layerGroup();
    const layerStationName = L.layerGroup();

    // Flags to prevent reloading
    let isALTrackLoaded = false;
    let isStationLayoutLoaded = false;
    let isStationNameLoaded = false;

    // 1. Load AL Track (red line)
    function loadALTrack() {
      if (isALTrackLoaded) return;
      showLoading();
      omnivore
        .kml("AL_Track_KKNK.kml")
        .on("ready", function () {
          this.eachLayer((layer) => {
            if (layer.setStyle) {
              layer.setStyle({ color: "red", weight: 3 });
            }
            layerALTrack.addLayer(layer);
          });
          if (layerALTrack.getLayers().length) {
            map.fitBounds(layerALTrack.getBounds());
          }
          isALTrackLoaded = true;
          hideLoading();
        })
        .on("error", (err) => {
          console.error("Error loading AL Track KML:", err);
          alert("Error loading AL Track data");
          hideLoading();
        });
    }

    // 2. Load Station Layout (gray)
    function loadStationLayout() {
      if (isStationLayoutLoaded) return;
      showLoading();
      omnivore
        .kml("Station.kml")
        .on("ready", function () {
          this.eachLayer((layer) => {
            if (layer.setStyle) {
              layer.setStyle({ color: "gray", weight: 2 });
            }
            layerStationLayout.addLayer(layer);
          });
          isStationLayoutLoaded = true;
          hideLoading();
        })
        .on("error", (err) => {
          console.error("Error loading Station KML:", err);
          alert("Error loading Station Layout data");
          hideLoading();
        });
    }

    // 3. Load Station Name (train icons + permanent labels)
    function loadStationName() {
      if (isStationNameLoaded) return;
      showLoading();

      // Define icons for different styles
      const icons = {
        station: L.AwesomeMarkers.icon({
          icon: "train",
          markerColor: "green",
          prefix: "fa",
        }),
        stop: L.AwesomeMarkers.icon({
          icon: "pause",
          markerColor: "orange",
          prefix: "fa",
        }),
        origin: L.AwesomeMarkers.icon({
          icon: "home",
          markerColor: "gray",
          prefix: "fa",
        }),
        default: L.AwesomeMarkers.icon({
          icon: "map-marker",
          markerColor: "blue",
          prefix: "fa",
        }),
      };

      const timeoutId = setTimeout(() => {
        hideLoading();
        alert(
          "Loading Station Name data timeout. Please check if Station_Name.kml is accessible."
        );
        isStationNameLoaded = false;
      }, 15000);

      omnivore
        .kml("Station_Name.kml")
        .on("ready", function () {
          clearTimeout(timeoutId);

          let markerCount = 0;

          this.eachLayer((layer) => {
            try {
              if (layer.feature && layer.feature.geometry) {
                // Get station name from KML
                const props = layer.feature.properties || {};
                const label =
                  props.name || props.Name || layer.feature.id || "No name";

                // Get styleUrl from feature id or properties
                let styleUrl = layer.feature.id || props.styleUrl || null;

                if (styleUrl && styleUrl.startsWith("#")) {
                  styleUrl = styleUrl.substring(1);
                }

                const icon = icons[styleUrl] || icons.default;

                if (layer.getLatLng && label) {
                  const marker = L.marker(layer.getLatLng(), { icon: icon }).bindTooltip(
                    label,
                    {
                      permanent: true,
                      direction: "top",
                      offset: [0, -10],
                      className: "station-tooltip",
                    }
                  );
                  layerStationName.addLayer(marker);
                  markerCount++;
                }
              }
            } catch (error) {
              console.error("Error processing layer:", error, layer);
            }
          });

          if (markerCount === 0) {
            alert(
              "Warning: No station markers were created. Check the KML structure."
            );
          }

          isStationNameLoaded = true;
          hideLoading();
        })
        .on("error", (err) => {
          clearTimeout(timeoutId);
          console.error("Error loading Station Name KML:", err);
          alert("Error loading Station Name data");
          hideLoading();
          isStationNameLoaded = false;
        });
    }

    // Layer control overlays
    const overlays = {
      "AL Track KKNK (red)": layerALTrack,
      "Station Layout (gray)": layerStationLayout,
      "Station Name (train icon)": layerStationName,
    };

    const layerControl = L.control.layers(null, overlays, {
      collapsed: false,
    }).addTo(map);

    // Handle overlay add event to load data on demand
    map.on("overlayadd", (e) => {
      switch (e.name) {
        case "AL Track KKNK (red)":
          loadALTrack();
          layerALTrack.addTo(map);
          break;
        case "Station Layout (gray)":
          loadStationLayout();
          layerStationLayout.addTo(map);
          break;
        case "Station Name (train icon)":
          loadStationName();
          layerStationName.addTo(map);
          break;
      }
    });

    // Add legend control
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function (map) {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div class="legend-item">
          <span class="legend-color" style="background-color: red;"></span>
          AL Track KKNK
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: gray;"></span>
          Station Layout
        </div>
        <div class="legend-item">
          <i class="fa fa-train legend-icon" style="color: green;"></i>
          Station (สถานี)
        </div>
        <div class="legend-item">
          <i class="fa fa-pause legend-icon" style="color: orange;"></i>
          Stop (ที่หยุดรถ)
        </div>
        <div class="legend-item">
          <i class="fa fa-home legend-icon" style="color: gray;"></i>
          Origin (ต้นทาง)
        </div>
      `;
      return div;
    };
    legend.addTo(map);

    // Initialize map with AL Track loaded and shown
    loadALTrack();
    layerALTrack.addTo(map);

    // Add scale control (metric only)
    L.control
      .scale({
        metric: true,
        imperial: false,
        position: "bottomleft",
      })
      .addTo(map);

    // Move zoom control to top right
    map.removeControl(map.zoomControl);
    L.control.zoom({
      position: "topright",
    }).addTo(map);

    // Log clicks for debug
    map.on("click", (e) => {
      console.log("Clicked at:", e.latlng);
    });

    // Global error logging
    window.addEventListener("error", (e) => {
      console.error("Global error:", e.error);
    });
  </script>
</body>
</html>
