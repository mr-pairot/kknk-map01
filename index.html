<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Leaflet Map (KML + GeoJSON + Icons)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Omnivore (for KML) -->
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <!-- AwesomeMarkers -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    
    /* Loading indicator */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    
    /* Custom tooltip styles */
    .leaflet-tooltip {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 3px;
      padding: 5px 8px;
      font-size: 12px;
      font-weight: bold;
    }
    
    /* Legend */
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      line-height: 18px;
      font-size: 14px;
    }
    
    .legend-item {
      margin: 3px 0;
    }
    
    .legend-color {
      width: 20px;
      height: 3px;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">
    <i class="fa fa-spinner fa-spin"></i> Loading...
  </div>

  <script>
    const map = L.map('map').setView([16.5, 102.5], 8);

    // Loading indicator functions
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // Base map
    const baseMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Initialize all layer groups
    const layerALTrack = L.layerGroup();
    const layerStation = L.layerGroup();
    const layerStationName = L.layerGroup();

    // State tracking
    let isALTrackLoaded = false;
    let isStationLoaded = false;
    let isStationNameLoaded = false;

    // 1. AL Track (red)
    function loadALTrack() {
      if (!isALTrackLoaded) {
        showLoading();
        omnivore.kml("AL_Track_KKNK.kml")
          .on('ready', function () {
            this.eachLayer(layer => {
              if (layer.setStyle) {
                layer.setStyle({ color: "red", weight: 3 });
              }
            });
            
            // Add to layer group
            this.eachLayer(layer => {
              layerALTrack.addLayer(layer);
            });
            
            // Fit bounds only if this is the first layer
            if (layerALTrack.getLayers().length > 0) {
              map.fitBounds(layerALTrack.getBounds());
            }
            
            isALTrackLoaded = true;
            hideLoading();
          })
          .on('error', function(err) {
            console.error('Error loading AL Track KML:', err);
            hideLoading();
            alert('Error loading AL Track data');
          });
      }
    }

    // 2. Station (gray)
    function loadStation() {
      if (!isStationLoaded) {
        showLoading();
        omnivore.kml("Station.kml")
          .on('ready', function () {
            this.eachLayer(layer => {
              if (layer.setStyle) {
                layer.setStyle({ color: "gray", weight: 2 });
              }
              layerStation.addLayer(layer);
            });
            isStationLoaded = true;
            hideLoading();
          })
          .on('error', function(err) {
            console.error('Error loading Station KML:', err);
            hideLoading();
            alert('Error loading Station data');
          });
      }
    }

    // 3. Station Name (Train icons + permanent labels)
    function loadStationName() {
      if (!isStationNameLoaded) {
        showLoading();
        console.log('Loading Station Name...');
        
        const trainIcon = L.AwesomeMarkers.icon({
          icon: 'train',
          markerColor: 'blue',
          prefix: 'fa'
        });

        // Add timeout to prevent hanging
        const timeoutId = setTimeout(() => {
          hideLoading();
          console.error('Station Name loading timeout');
          alert('Loading Station Name data timeout. Please check if Station_Name.kml file exists and is accessible.');
          isStationNameLoaded = false; // Reset flag so user can try again
        }, 15000); // 15 seconds timeout

        const kmlLayer = omnivore.kml("Station_Name.kml");
        
        kmlLayer.on('ready', function () {
          clearTimeout(timeoutId);
          console.log('Station Name KML loaded, processing layers...');
          console.log('Total layers found:', this.getLayers().length);
          
          let markerCount = 0;
          let processedCount = 0;
          
          this.eachLayer(layer => {
            processedCount++;
            try {
              console.log(`Processing layer ${processedCount}:`, layer);
              
              // Check different possible property names
              let label = null;
              if (layer.feature && layer.feature.properties) {
                label = layer.feature.properties.name || 
                       layer.feature.properties.Name || 
                       layer.feature.properties.NAME ||
                       layer.feature.properties.description ||
                       layer.feature.properties.Description;
                       
                console.log(`Layer ${processedCount} properties:`, layer.feature.properties);
              }
              
              // Alternative: check if layer has options.title (sometimes used by omnivore)
              if (!label && layer.options && layer.options.title) {
                label = layer.options.title;
              }
              
              // Check if it's a marker and get popup content
              if (!label && layer.getPopup && layer.getPopup()) {
                label = layer.getPopup().getContent();
              }
              
              // If still no label, use coordinates as fallback
              if (!label && layer.getLatLng && layer.getLatLng()) {
                const latlng = layer.getLatLng();
                label = `Station (${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)})`;
              }
              
              if (layer.getLatLng && layer.getLatLng() && label) {
                const marker = L.marker(layer.getLatLng(), { icon: trainIcon })
                  .bindTooltip(label, { 
                    permanent: true, 
                    direction: 'top', 
                    offset: [0, -10],
                    className: 'station-tooltip'
                  });
                layerStationName.addLayer(marker);
                markerCount++;
                console.log(`Created marker ${markerCount}: ${label}`);
              } else {
                console.warn(`Layer ${processedCount} skipped - no valid data:`, {
                  hasLatLng: !!(layer.getLatLng && layer.getLatLng()),
                  label: label,
                  layer: layer
                });
              }
            } catch (error) {
              console.error(`Error processing layer ${processedCount}:`, error, layer);
            }
          });
          
          console.log(`Station Name processing complete: ${markerCount} markers created from ${processedCount} layers`);
          
          if (markerCount === 0) {
            console.warn('No markers were created. This might indicate a parsing issue.');
            alert('Warning: No station markers were created. The KML file might have a different structure than expected.');
          }
          
          isStationNameLoaded = true;
          hideLoading();
        });
        
        kmlLayer.on('error', function(err) {
          clearTimeout(timeoutId);
          console.error('Error loading Station Name KML:', err);
          hideLoading();
          alert('Error loading Station Name data: ' + (err.message || 'Unknown error'));
          isStationNameLoaded = false; // Reset flag so user can try again
        });
        
        // Monitor loading progress
        kmlLayer.on('addlayer', function(e) {
          console.log('Layer added to KML:', e.layer);
        });
      }
    }

    // 4. DOH layer removed as requested

    // Layer control with custom overlay control
    const overlays = {
      "AL Track KKNK (red)": layerALTrack,
      "Station (gray)": layerStation,
      "Station Name (train icon)": layerStationName
    };

    // Add layer control
    const layerControl = L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    // Handle layer add/remove events
    map.on("overlayadd", function(e) {
      switch(e.name) {
        case "AL Track KKNK (red)":
          loadALTrack();
          break;
        case "Station (gray)":
          loadStation();
          break;
        case "Station Name (train icon)":
          loadStationName();
          break;
      }
    });

    map.on("overlayremove", function(e) {
      // Layers are automatically removed from map by Leaflet
      // But we keep the data loaded for next time
    });

    // Add legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div class="legend-item">
          <span class="legend-color" style="background-color: red;"></span>
          AL Track KKNK
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: gray;"></span>
          Station
        </div>
        <div class="legend-item">
          <i class="fa fa-train" style="color: blue; margin-right: 8px;"></i>
          Station Name
        </div>
      `;
      return div;
    };
    legend.addTo(map);

    // Initialize with AL Track loaded and displayed
    loadALTrack();
    layerALTrack.addTo(map);

    // Add scale control
    L.control.scale({
      metric: true,
      imperial: false,
      position: 'bottomleft'
    }).addTo(map);

    // Add zoom control to top right
    map.removeControl(map.zoomControl);
    L.control.zoom({
      position: 'topright'
    }).addTo(map);

    // Error handling for missing files
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
    });

    // Handle map click for debugging
    map.on('click', function(e) {
      console.log('Clicked at:', e.latlng);
    });

  </script>
</body>
</html>
